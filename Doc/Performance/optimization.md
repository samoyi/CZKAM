# 性能优化

## 优化策略
### 目前已经实现的优化策略
* 静态资源CND存储
* 静态资源设置超长时间缓存
* Preloading
* Lazy Loading
* 合并请求
* 耗时操作使用WebWorker并缓存结果
* 脚本合并压缩、服务器压缩
* 加速渲染

### 目前没有实现的优化策略
* 用户上传图片的自动无损压缩  
    前期的图片已经统一压缩，之后客户上传图片时，需要自己先压缩再上传。
* 用户上传图片的自动有损压缩  
    虽然作品组件提供了缩略图和大图两种图片规格，但目前并没有实现用户上传图片压缩的功能，
    所以作品组件的缩略图和大图都是同一个图片。需要通过有损压缩生成缩略图。
* 静态资源多域名部署突破单域名并发数限制  
    不过目前是两个域名，且一次加载时同一域名的请求数不超过10个，应该也不需要再增加DNS查
    询成本来添加新域名。


## 使用工具
### Chrome Developer Tools
* Chrome Audits
    * 该工具之前不用翻墙就能使用，现在（60版本开始）应该是因为集成了lighthouse导致必须翻墙。
    * 该工具现在只有移动端审查模式，而且是以3G的网速。
* Memory
* Performance
* Network

### Google PageSpeed Insights


## 静态资源CND存储
图片、脚本和视频使用阿里云对象存储（OSS）。


## 静态资源设置超长时间缓存
### max-age 设置
1. 静态资源统一设定为10年（315360000）的`max-age`。包括以下资源：
    * 由用户上传的图片和视频
    * build后的js文件
    * sprite图片
2. 上述三类资源中的后两类需要通过文件名的版本号改变来实现更新。详见下面的【更新策略】
3. 之前的同事在编写网站后台上传图片至OSS时并未设置`Cache-Control`，所以用户上传的内容
没有`max-age`

### 更新策略
1. 例如当修改了一个js文件后，将该文件上传到服务器，不覆盖之前版本的js文件，而是根据约
定的版本规则将其改名或放在不同的目录。
2. html文件里修改对该js文件的引用路径。
3. 如果要版本回滚，只需要在html文件里修改回之前的路径即可。
4. 目前的具体方法是在静态文件名称后面加上年月日（例如`abc.20170427.js`），上传到OSS上
之前版本同一个目录下，然后再修改html文件中的路径并上传。
5. 虽然看到很多网站是使用请求参数的形式`abc.js?v=xyz`，但这种方法有可能会导致在请求资
源的过程中，某些缓存机制不合理的节点继续使用缓存的文件。  
最有名的就是长城宽带的例子，现在不知道是否还有，但至少在几年前，资源url的query部分的改
变并不会引起更新，也不会校验缓存文件和原始文件是否一致，因此必须要通过文件名的改变才能刷
新长城宽带的缓存。参考以下：
    * [为什么大家不选长城宽带？为什么又会选长城宽带？ - 知乎](https://www.zhihu.com/question/37320282/answer/74038997)
    * [大公司里怎样开发和部署前端代码？ - 张云龙的回答 - 知乎](https://www.zhihu.com/question/20790576/answer/32602154)下面的评论
    * [深圳长城宽带静态文件缓存代理，3个字-伤不起！](https://blog.csdn.net/huanghr_1/article/details/7680786)


## Preloading
* 暂时没有需要预加载的资源（作品大图每次只有用户点击后才会单独加载一张，不需要提前加载）


## Lazy Loading
* 只有当前需要显示的作品才加载缩略图


## 合并请求
* 图标sprite
* 虽然可以可以实现每个页面所有的数据库数据（目前是使用json文件）由相应的`main.vue`一次
性请求，然后分发给不同的组件。但并没有这样实现，因为该网站是纯PC端，网络情况比较好，进入
一个组件后多一次本地服务器的请求耗时很少，而为了实现合并请求的话，需要后端把相关性不强的
数据进行拼接，前端再拆分然后分发，代码逻辑变得复杂，不利于维护，得不偿失。


## 耗时操作使用WebWorker并缓存结果
暂时没有耗时操作


## 脚本合并压缩、服务器压缩
1. webpack打包并压缩
2. 阿里云OSS设置GZIP压缩  
    OSS上传JS文件默认的Content-Type不会启用GZIP，启用方法参考[文档](https://help.aliyun.com/knowledge_detail/39645.html)


## 加速渲染
* 给没有通过样式指定尺寸的`image`指定`width`和`height`属性
